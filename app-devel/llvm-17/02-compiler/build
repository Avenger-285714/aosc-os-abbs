llvm_ir_strip () {
    mkdir -pv "$SRCDIR"/strip-tmp
    cat << 'EOF' > "$SRCDIR"/strip-tmp/build.ninja
rule ir-strip
  command = TMPDIR="$$(mktemp -d)" && cd "$$TMPDIR" && llvm-ar x "$in" && for i in *.o; do if llvm-bcanalyzer "$$i" > /dev/null; then echo "-- Removing debug markers in $$i"; opt --strip-debug "$$i" -o "$$i"; fi done && llvm-ar rcs "$out" *.o && rm -rf "$$TMPDIR"
  description = Stripping $in ...

EOF
    abinfo "Removing installed LTO archives ..."
    rm -v "$PKGDIR"/usr/lib/llvm-17/lib/*.a
    abinfo "Generating stripping scripts ..."
    for i in "$SRCDIR"/fakeroot/usr/lib/llvm-17/lib/*.a; do
        local outfile="$(basename "$i")"
        printf "build $PKGDIR/usr/lib/llvm-17/lib/$outfile: ir-strip $i\n\n" >> "$SRCDIR"/strip-tmp/build.ninja
    done
    abinfo "Executing LLVM IR stripping scripts ..."
    ninja -C "$SRCDIR"/strip-tmp/
}

abinfo "Installing all files from LLVM ..."
mkdir -pv "$PKGDIR"
cp -arv "$SRCDIR"/fakeroot/* \
    "$PKGDIR"/

if [[ "$NOLTO" = 0 ]]; then
  abinfo "Preparing for LLVM IR strip in LTO archives ..."
  llvm_ir_strip
else
  abinfo "Dropping executable bit from static libraries ..."
  chmod -v 644 "$PKGDIR"/usr/lib/llvm-17/lib/*.a
fi

abinfo "Dropping runtime libraries ..."
rm -fv "$PKGDIR"/usr/lib/llvm-17/lib/lib{LLVM,LTO}*.so*
rm -fv "$PKGDIR"/usr/lib/llvm-17/lib/libLLVM-${PKGVER%.*}*.so*
rm -fv "$PKGDIR"/usr/lib/llvm-17/lib/LLVMgold.so
rm -fv "$PKGDIR"/usr/lib/llvm-17/lib/libc++*.so*

abinfo "Dropping six.py ..."
rm -fv "$PKGDIR"/usr/lib/llvm-17/lib/python*/site-packages/six.py

abinfo "Stripping static libraries ..."
strip --verbose \
      --strip-debug \
      --enable-deterministic-archives \
      --remove-section=.comment \
      --remove-section=.note \
      "$PKGDIR"/usr/lib/llvm-17/lib/*.a

abinfo "Making compatible version symlinks ..."
ln -sv "${PKGVER%%.*}" "$PKGDIR"/usr/lib/llvm-17/lib/clang/"${PKGVER}"

abinfo "Moving conflicting LLVM replacements for GCC-compatible files ..."
mkdir -pv "$PKGDIR"/usr/lib/llvm-17/lib/llvm/
if ! ab_match_arch loongson3 && \
   ! ab_match_arch mips64r6el; then
    mv -v \
        "$PKGDIR"/usr/lib/llvm-17/include/libunwind.* \
        "$PKGDIR"/usr/lib/llvm-17/include/unwind* \
        "$PKGDIR"/usr/lib/llvm-17/include/__libunwind_config.h \
        "$PKGDIR"/usr/lib/llvm-17/include/llvm/
fi
[ -e "$PKGDIR"/usr/lib/llvm-17/lib/libunwind.so ] && \
     mv -v "$PKGDIR"/usr/lib/llvm-17/lib/libunwind.* "$PKGDIR"/usr/lib/llvm-17/lib/llvm/ || true
[ -e "$PKGDIR"/usr/lib/llvm-17/lib/libgomp.so ] && \
     mv -v "$PKGDIR"/usr/lib/llvm-17/lib/libgomp.* "$PKGDIR"/usr/lib/llvm-17/lib/llvm/ || true

abinfo "Creating convenience symlinks for executables ..."
mkdir -pv "$PKGDIR"/usr/bin
for i in "$PKGDIR"/usr/lib/llvm-17/bin/*; do
    ln -sv ../lib/llvm-17/bin/$(basename $i) \
        "$PKGDIR"/usr/bin/$(basename $i)-17
done
