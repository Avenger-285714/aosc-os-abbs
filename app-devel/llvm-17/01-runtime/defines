PKGNAME=llvm-runtime-17
PKGSEC=libs
PKGDEP="gcc-runtime libedit libffi ncurses zlib"
BUILDDEP="swig doxygen ocaml findlib llvm-17"
BUILDDEP__RETRO="llvm-17"
BUILDDEP__ARMV4="${BUILDDEP__RETRO}"
BUILDDEP__ARMV6HF="${BUILDDEP__RETRO}"
BUILDDEP__ARMV7HF="${BUILDDEP__RETRO}"
BUILDDEP__I486="${BUILDDEP__RETRO}"
BUILDDEP__LOONGSON2F="${BUILDDEP__RETRO}"
BUILDDEP__POWERPC="${BUILDDEP__RETRO}"
BUILDDEP__PPC64="${BUILDDEP__RETRO}"
PKGDES="Low Level Virtual Machine Infrastructure (runtime libraries, version 17)"

AB_FLAGS_O3=1
AB_FLAGS_O3__RETRO=0

USECLANG=1
USECLANG__ARMV4=0
USECLANG__ARMV6HF=0
USECLANG__LOONGSON2F=0
# FIXME: libLLVM-16.so linkage failure.
# relocation R_MIPS_TLS_TPREL_HI16 against `a local symbol' cannot be used
# when making a shared object; recompile with -fPIC.
USECLANG__LOONGSON3=0
# FIXME: Crashes during code generation.
USECLANG__MIPS64R6EL=0

NOLTO=1

ABSPLITDBG__RETRO=0

# Figure out which feature/module to enable
_LLVM_MIN_SET="clang" # for Afterglow and other new ports
_LLVM_BASE_SET="${_LLVM_MIN_SET};lld;lldb;clang-tools-extra;polly" # for main-T2 arch (e.g. loongson3, riscv64 ...)
_LLVM_FULL_SET="${_LLVM_BASE_SET};mlir;bolt;flang;libclc" # for main-T1 arch (e.g. amd64, arm64 ...)

_LLVM_MIN_RUNTIME_SET="libunwind" # for Afterglow and other new ports
_LLVM_BASE_RUNTIME_SET="${_LLVM_MIN_RUNTIME_SET};libcxx;libcxxabi;compiler-rt"
_LLVM_FULL_RUNTIME_SET="${_LLVM_BASE_RUNTIME_SET};pstl;openmp"
# FIXME: Runtime libraries does not build without lld.
_LLVM_BASE_RUNTIME_SET__LOONGSON3=""
_LLVM_BASE_RUNTIME_SET__MIPS64R6EL=""

CMAKE_AFTER="-DLLVM_BUILD_LLVM_DYLIB=ON \
             -DLLVM_DYLIB_EXPORT_ALL=ON \
             -DLLVM_LINK_LLVM_DYLIB=ON \
             -DLLVM_ENABLE_RTTI=ON \
             -DLLVM_ENABLE_FFI=ON \
             -DLLVM_BUILD_DOCS=OFF \
             -DLLVM_ENABLE_PER_TARGET_RUNTIME_DIR=OFF \
             -DFFI_INCLUDE_DIR=$(pkg-config --variable=includedir libffi) \
             -DLLVM_BINUTILS_INCDIR=/usr/include \
             -DLLVM_INSTALL_UTILS=ON \
             -DLLVM_INCLUDE_TESTS=OFF \
             -DLLVM_USE_LINKER=lld \
             -DCMAKE_INSTALL_PREFIX=/usr/lib/llvm-17 \
             -DCMAKE_SHARED_LINKER_FLAGS=-lzstd \
             -DCMAKE_BUILD_TYPE=RelWithDebInfo"
# Mainline
CMAKE_AFTER__BASE=" \
             ${CMAKE_AFTER} \
             -DLLVM_ENABLE_PROJECTS=${_LLVM_BASE_SET} \
             -DLLVM_ENABLE_RUNTIMES=${_LLVM_BASE_RUNTIME_SET}"
CMAKE_AFTER__FULL=" \
             ${CMAKE_AFTER} \
             -DLLVM_ENABLE_PROJECTS=${_LLVM_FULL_SET} \
             -DLLVM_ENABLE_RUNTIMES=${_LLVM_FULL_RUNTIME_SET}"
CMAKE_AFTER__AMD64="${CMAKE_AFTER__FULL}"
CMAKE_AFTER__ARM64="${CMAKE_AFTER__FULL}"
CMAKE_AFTER__LOONGARCH64=" \
              ${CMAKE_AFTER__FULL} \
             -DLLVM_USE_LINKER=bfd \
             -DLLVM_PARALLEL_LINK_JOBS=2"
CMAKE_AFTER__LOONGSON3=" \
             ${CMAKE_AFTER} \
             -DLLVM_ENABLE_PROJECTS=${_LLVM_BASE_SET} \
             -DLLVM_ENABLE_RUNTIMES=${_LLVM_BASE_RUNTIME_SET__LOONGSON3} \
             -DLLVM_PARALLEL_LINK_JOBS=2 \
             -DLLVM_USE_LINKER="
CMAKE_AFTER__MIPS64R6EL=" \
             ${CMAKE_AFTER} \
             -DLLVM_ENABLE_PROJECTS=${_LLVM_BASE_SET} \
             -DLLVM_ENABLE_RUNTIMES=${_LLVM_BASE_RUNTIME_SET__MIPS64R6EL} \
             -DLLVM_USE_LINKER=bfd"
CMAKE_AFTER__RISCV64="${CMAKE_AFTER__BASE} -DLLVM_PARALLEL_LINK_JOBS=2"
CMAKE_AFTER__PPC64EL="${CMAKE_AFTER__BASE} -DLLVM_PARALLEL_LINK_JOBS=2"

# Retro
CMAKE_AFTER__RETRO=" \
             -DLLVM_BUILD_LLVM_DYLIB=ON \
             -DLLVM_DYLIB_EXPORT_ALL=ON \
             -DLLVM_LINK_LLVM_DYLIB=ON \
             -DLLVM_ENABLE_RTTI=ON \
             -DLLVM_ENABLE_FFI=ON \
             -DLLVM_BUILD_DOCS=OFF \
             -DLLVM_ENABLE_PROJECTS=${_LLVM_MIN_SET} \
             -DLLVM_ENABLE_PER_TARGET_RUNTIME_DIR=OFF \
             -DFFI_INCLUDE_DIR=$(pkg-config --variable=includedir libffi) \
             -DLLVM_BINUTILS_INCDIR=/usr/include \
             -DLLVM_INSTALL_UTILS=ON \
             -DLLVM_INCLUDE_TESTS=OFF \
             -DLLVM_USE_LINKER=bfd \
             -DCMAKE_INSTALL_PREFIX=/usr/lib/llvm-17"
CMAKE_AFTER__ARMV4="${CMAKE_AFTER__RETRO}"
CMAKE_AFTER__ARMV6HF="${CMAKE_AFTER__RETRO}"
CMAKE_AFTER__ARMV7HF="${CMAKE_AFTER__RETRO}"
CMAKE_AFTER__I486="${CMAKE_AFTER__RETRO}"
CMAKE_AFTER__LOONGSON2F="${CMAKE_AFTER__RETRO}"
CMAKE_AFTER__M68K="${CMAKE_AFTER__RETRO}"
CMAKE_AFTER__POWERPC="${CMAKE_AFTER__RETRO}"
CMAKE_AFTER__PPC64="${CMAKE_AFTER__RETRO}"
